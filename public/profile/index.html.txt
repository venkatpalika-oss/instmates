<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Technician Profile | InstMates</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="/assets/css/style.css?v=2026-02-22" />
</head>

<body data-page="profile">

<div id="siteHeader"></div>

<nav class="crumbs">
  <a href="/">Home</a><span>‚Ä∫</span>
  <a href="/technicians/">Profiles</a><span>‚Ä∫</span>
  <span class="current">Technician Profile</span>
</nav>

<main class="container">

<section id="profileContainer" class="panel">
  <p class="muted">Loading profile‚Ä¶</p>
</section>

</main>

<div id="siteFooter"></div>

<script src="/assets/js/includes.js?v=3"></script>

<script type="module">
import { db } from "/assets/js/firebase.js";
import { doc, getDoc }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const container = document.getElementById("profileContainer");

const params = new URLSearchParams(window.location.search);
const uid = params.get("uid");

if (!uid) {
  container.innerHTML = "<p class='muted'>Profile not found.</p>";
} else {
  loadProfile(uid);
}

async function loadProfile(uid) {

  const snap = await getDoc(doc(db, "profiles", uid));

  if (!snap.exists()) {
    container.innerHTML = "<p class='muted'>Profile not found.</p>";
    return;
  }

  const p = snap.data();

  /* ================= SAFE NESTED ACCESS ================= */

  const basic = p.basicInfo || {};
  const professional = p.professional || {};
  const achievement = p.achievement || {};
  const status = p.profileStatus || {};

  if (status.isPublic === false) {
    container.innerHTML = "<p class='muted'>This profile is private.</p>";
    return;
  }

  /* ================= SKILLS ================= */

  const skillsArray = professional.analyzersWorked || [];

  const skillsHTML = skillsArray.length
    ? `<div class="tags">
        ${skillsArray.map(skill =>
          `<span class="tag">${escapeHTML(skill)}</span>`
        ).join("")}
       </div>`
    : "<p class='muted'>No analyzers listed.</p>";

  /* ================= ACHIEVEMENT ================= */

  const troubleshootingHTML = achievement.title
    ? `<div class="card" style="margin-top:15px;">
         <h4>${escapeHTML(achievement.title)}</h4>
         <p>${escapeHTML(achievement.description || "")}</p>
         <p><strong>Impact:</strong> ${escapeHTML(achievement.impact || "")}</p>
       </div>`
    : "<p class='muted'>No major troubleshooting added.</p>";

  container.innerHTML = `

  <!-- HERO SECTION -->
  <div style="text-align:center;padding:30px 0">

    <img src="${basic.profilePhoto || "/assets/images/default-avatar.png"}"
         style="width:140px;height:140px;border-radius:50%;object-fit:cover;border:4px solid #fff;box-shadow:0 5px 20px rgba(0,0,0,0.15)">

    <h1 style="margin-top:15px">
      ${escapeHTML(basic.fullName || "Technician")}
    </h1>

    <p class="muted">${escapeHTML(basic.headline || "")}</p>
    <p class="muted">üìç ${escapeHTML(basic.location || "")}</p>
    <p class="muted">${basic.experienceYears || 0} Years Experience</p>

    <a href="/message/?to=${uid}" class="btn btn-primary" style="margin-top:15px">
      Message
    </a>

  </div>

  <hr>

  <!-- SPECIALIZATION -->
  <h3>Specialization</h3>
  <p>${escapeHTML(professional.specialization || "Not specified")}</p>

  <hr>

  <!-- PLANT TYPE -->
  <h3>Plant Type</h3>
  <p>${escapeHTML(professional.plantType || "Not specified")}</p>

  <hr>

  <!-- ANALYZERS -->
  <h3>Analyzers Worked</h3>
  ${skillsHTML}

  <hr>

  <!-- MAJOR TROUBLESHOOTING -->
  <h3>Major Troubleshooting Case</h3>
  ${troubleshootingHTML}

  `;
}

function escapeHTML(str) {
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}
</script>

</body>
</html>